<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Activeness ¬∑ English Quest</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg"/>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0F0A1E; --surface: #1A1230; --surface2: #241A3A;
      --border: #2E2250; --purple: #8B5CF6; --purple-bright: #A78BFA;
      --accent: #F59E0B; --green: #10B981; --red: #EF4444;
      --blue: #3B82F6; --pink: #EC4899; --teal: #14B8A6;
      --text: #F1EEFF; --muted: #7C6FA0; --white: #fff;
    }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* HEADER */
    header {
      padding: 20px 20px 24px; position: relative;
      background: linear-gradient(180deg, #1A0F35 0%, var(--bg) 100%);
      border-bottom: 1px solid var(--border);
    }
    .header-row { display: flex; align-items: center; justify-content: space-between; max-width: 960px; margin: 0 auto; }
    .back-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 600; padding: 8px 16px; border-radius: 999px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .back-btn:hover { color: var(--text); border-color: var(--purple); }
    .header-center { text-align: center; flex: 1; }
    .header-title { font-family: 'Syne', sans-serif; font-size: clamp(1.4rem, 4vw, 2rem); font-weight: 800; background: linear-gradient(135deg, #A78BFA, #F59E0B); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .header-sub { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }
    .header-right { min-width: 80px; display: flex; justify-content: flex-end; }
    .teacher-badge { background: linear-gradient(135deg, var(--accent), #D97706); color: #fff; font-size: 0.78rem; font-weight: 700; padding: 7px 14px; border-radius: 999px; display: flex; align-items: center; gap: 6px; }
    .logout-x { cursor: pointer; opacity: 0.7; }
    .logout-x:hover { opacity: 1; }

    /* MAIN */
    main { max-width: 960px; margin: 0 auto; padding: 24px 16px 80px; }

    /* LOGIN WALL */
    .login-wall { display: flex; align-items: center; justify-content: center; min-height: 60vh; }
    .login-box { background: var(--surface); border: 1px solid var(--border); border-radius: 24px; padding: 40px 32px; width: 100%; max-width: 380px; text-align: center; }
    .login-icon { font-size: 2.5rem; margin-bottom: 16px; }
    .login-title { font-family: 'Syne', sans-serif; font-size: 1.5rem; font-weight: 800; margin-bottom: 6px; }
    .login-sub { font-size: 0.88rem; color: var(--muted); margin-bottom: 28px; }
    .input-field { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 13px 16px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; color: var(--text); outline: none; margin-bottom: 12px; }
    .input-field:focus { border-color: var(--purple); }
    .input-field::placeholder { color: var(--muted); }
    .login-error { font-size: 0.82rem; color: var(--red); margin-bottom: 12px; display: none; }
    .btn-login { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--purple), #6D28D9); color: #fff; font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 1rem; border: none; border-radius: 12px; cursor: pointer; transition: opacity 0.2s; }
    .btn-login:hover { opacity: 0.9; }

    /* CLASS SELECTOR */
    .top-bar { display: flex; gap: 12px; align-items: center; margin-bottom: 24px; flex-wrap: wrap; }
    .class-select { flex: 1; min-width: 160px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; color: var(--text); outline: none; cursor: pointer; }
    .class-select:focus { border-color: var(--purple); }
    .class-select option { background: var(--surface); }
    .class-info { font-size: 0.82rem; color: var(--muted); font-family: 'DM Mono', monospace; }

    /* LEGEND */
    .legend { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.78rem; font-family: 'DM Mono', monospace; color: var(--muted); background: var(--surface); border: 1px solid var(--border); padding: 5px 10px; border-radius: 999px; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    /* STUDENT CARDS GRID */
    .students-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }

    /* STUDENT CARD */
    .student-card { background: var(--surface); border: 1px solid var(--border); border-radius: 18px; overflow: hidden; transition: border-color 0.2s, transform 0.15s; }
    .student-card:hover { border-color: var(--purple); transform: translateY(-2px); }
    .card-top { padding: 14px 16px 10px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); }
    .card-no { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--muted); width: 22px; flex-shrink: 0; }
    .card-name { font-family: 'Syne', sans-serif; font-size: 0.88rem; font-weight: 700; flex: 1; line-height: 1.2; }
    .card-total { font-family: 'DM Mono', monospace; font-size: 0.78rem; font-weight: 600; padding: 3px 10px; border-radius: 999px; background: var(--surface2); border: 1px solid var(--border); }
    .card-total.high { background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.4); color: var(--green); }
    .card-total.mid  { background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.4); color: var(--accent); }
    .card-total.low  { background: rgba(239,68,68,0.1);  border-color: rgba(239,68,68,0.3);  color: var(--red); }

    /* ACTIVITY BUTTONS */
    .card-activities { padding: 10px 12px 12px; display: flex; flex-direction: column; gap: 6px; }
    .act-row { display: flex; align-items: center; gap: 8px; }
    .act-label { font-size: 0.72rem; color: var(--muted); width: 90px; flex-shrink: 0; font-family: 'DM Mono', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .act-controls { display: flex; align-items: center; gap: 6px; flex: 1; }
    .act-btn { width: 28px; height: 28px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: all 0.15s; flex-shrink: 0; line-height: 1; }
    .act-btn.plus  { background: rgba(139,92,246,0.2); border-color: var(--purple); color: var(--purple-bright); font-size: 1.1rem; }
    .act-btn.plus:hover  { background: var(--purple); color: #fff; }
    .act-btn.minus { color: var(--muted); font-size: 1rem; }
    .act-btn.minus:hover { background: rgba(239,68,68,0.15); border-color: var(--red); color: var(--red); }
    .act-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .act-val { font-family: 'DM Mono', monospace; font-size: 0.9rem; font-weight: 600; min-width: 24px; text-align: center; color: var(--text); transition: color 0.2s; }
    .act-val.changed { color: var(--accent); }

    /* Indicator badge */
    .card-indicator { margin: 0 12px 12px; font-size: 0.72rem; font-family: 'DM Mono', monospace; padding: 4px 10px; border-radius: 6px; text-align: center; font-weight: 600; }
    .ind-ultra  { background: linear-gradient(135deg,rgba(239,68,68,0.15),rgba(251,191,36,0.15)); color: #F97316; border: 1px solid rgba(249,115,22,0.5); }
    .ind-hyper  { background: rgba(251,191,36,0.15);  color: #FBBF24; border: 1px solid rgba(251,191,36,0.4); }
    .ind-super  { background: rgba(16,185,129,0.15);  color: var(--green); border: 1px solid rgba(16,185,129,0.3); }
    .ind-active { background: rgba(139,92,246,0.15);  color: var(--purple-bright); border: 1px solid rgba(139,92,246,0.3); }
    .ind-okay   { background: rgba(245,158,11,0.15);  color: var(--accent); border: 1px solid rgba(245,158,11,0.3); }
    .ind-not    { background: rgba(239,68,68,0.1);    color: var(--red);    border: 1px solid rgba(239,68,68,0.2); }

    /* Loading */
    .loading { text-align: center; padding: 60px; color: var(--muted); }
    .spinner { display: inline-block; width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--purple); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast */
    .toast { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 10px 22px; border-radius: 999px; font-size: 0.88rem; font-weight: 500; transition: transform 0.3s; z-index: 999; white-space: nowrap; pointer-events: none; }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.ok  { border-color: var(--green); color: var(--green); }
    .toast.err { border-color: var(--red); color: var(--red); }

    .hidden { display: none !important; }
    footer { text-align: center; padding: 20px; font-size: 0.82rem; color: var(--muted); border-top: 1px solid var(--border); }

    @media (max-width: 500px) {
      .students-grid { grid-template-columns: 1fr; }
      .act-label { width: 72px; }
    }

    .logout-btn { position: absolute; top: 20px; right: 20px; z-index: 2; background: rgba(255,255,255,0.12); border: 1.5px solid rgba(255,255,255,0.25); color: rgba(255,255,255,0.85); font-size: 0.78rem; font-weight: 600; padding: 6px 14px; border-radius: 999px; cursor: pointer; font-family: inherit; display: none; align-items: center; gap: 5px; }
    .logout-btn:hover { background: rgba(255,255,255,0.22); }
    .teacher-active .logout-btn { display: flex; }
  </style>
</head>
<body>

<header>
  <div class="header-row">
    
  <button class="logout-btn" onclick="doLogout()">&#128274; Logout</button>
  <a class="back-btn" href="index.html">‚Üê Back</a>
    <div class="header-center">
      <div class="header-title">Activeness</div>
      <div class="header-sub">English Quest ¬∑ Real-time tracker</div>
    </div>
    <div class="header-right" id="headerRight">
      <!-- filled by JS -->
    </div>
  </div>
</header>

<main>




  <!-- LOGIN WALL -->
  <div class="login-wall" id="loginWall">
    <div class="login-box">
      <div class="login-icon">üîê</div>
      <div class="login-title">Teacher Access</div>
      <div class="login-sub">This page is for teachers only.</div>
      <input class="input-field" type="text" id="loginUser" placeholder="Username"/>
      <input class="input-field" type="password" id="loginPass" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()"/>
      <div class="login-error" id="loginError">Incorrect username or password.</div>
      <button class="btn-login" onclick="doLogin()">Login</button>
    </div>
  </div>

  <!-- MAIN PANEL (hidden until logged in) -->
  <div id="mainPanel" class="hidden">
    <div class="top-bar">
      <select class="class-select" id="classSelect" onchange="loadClass()">
        <option value="">‚Äî Select a class ‚Äî</option>
        <option value="XE1">X E-1</option>
        <option value="XE4">X E-4</option>
        <option value="XE5">X E-5</option>
        <option value="XE6">X E-6</option>
        <option value="XE7">X E-7</option>
        <option value="XE8">X E-8</option>
        <option value="XE9">X E-9</option>
        <option value="XE10">X E-10</option>
        <option value="XE11">X E-11</option>
      </select>
      <span class="class-info" id="classInfo"></span>
    </div>

    <!-- Activity legend -->
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:#8B5CF6"></div>VB ¬∑ Vocab Box</div>
      <div class="legend-item"><div class="legend-dot" style="background:#3B82F6"></div>ANS ¬∑ Answering</div>
      <div class="legend-item"><div class="legend-dot" style="background:#10B981"></div>PRE ¬∑ Presenting</div>
      <div class="legend-item"><div class="legend-dot" style="background:#F59E0B"></div>DTO ¬∑ Task On Time</div>
      <div class="legend-item"><div class="legend-dot" style="background:#EC4899"></div>HH ¬∑ Helping Hand</div>
    </div>

    <div id="studentsList"></div>
  </div>

</main>

<footer>¬© 2025 <strong>English Quest</strong> ¬∑ SMA Negeri 6 Surakarta ¬∑ Built with ‚ù§Ô∏è by <strong>LaksMedia</strong></footer>
<div class="toast" id="toast"></div>

<script>
  const API = 'https://script.google.com/macros/s/AKfycbxBTC4vnFB3A73QwThdRxrUruvUNZRlpwwLFBjt5C0cJGIh8wz461ZCn3b9Y6wWPpyAGg/exec';

  const ACTS = [
    { key: 'Vocabulary Box',     short: 'VB',  col: '#8B5CF6' },
    { key: 'Answering',          short: 'ANS', col: '#3B82F6' },
    { key: 'Presenting',         short: 'PRE', col: '#10B981' },
    { key: 'Doing Task On Time', short: 'DTO', col: '#F59E0B' },
    { key: 'Helping Hand',       short: 'HH',  col: '#EC4899' },
  ];

  let savedUser = '', savedPass = '', currentClass = '';
  let studentsData = [];

  // Restore session
  savedUser = localStorage.getItem('eq_tu') || '';
  savedPass = localStorage.getItem('eq_tp') || '';
  if (savedUser && savedPass) verifyLogin(savedUser, savedPass, true);

  // ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function apiGet(params) {
    const url = API + '?' + new URLSearchParams(params);
    try { const res = await fetch(url); if (res.ok) return await res.json(); } catch(e) {}
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Date.now() + '_' + Math.random().toString(36).slice(2);
      const p  = { ...params, callback: cb, _t: Date.now() };
      const script = document.createElement('script');
      script.async = true;
      const timer = setTimeout(() => { cleanup(); reject(new Error('Timeout')); }, 15000);
      function cleanup() { delete window[cb]; try { if (script.parentNode) script.parentNode.removeChild(script); } catch(e){} clearTimeout(timer); }
      window[cb]     = d => { cleanup(); resolve(d); };
      script.onerror = () => { cleanup(); reject(new Error('Network error')); };
      script.src = API + '?' + new URLSearchParams(p);
      (document.body || document.head).appendChild(script);
    });
  }

  // ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function doLogin() {
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();
    await verifyLogin(u, p, false);
  }

  async function verifyLogin(u, p, silent) {
    try {
      const data = await apiGet({ action: 'checkLogin', username: u, password: p });
      if (data.ok) {
        savedUser = u; savedPass = p;
        localStorage.setItem('eq_tu', u); localStorage.setItem('eq_tp', p);
        document.getElementById('loginWall').classList.add('hidden');
        document.getElementById('mainPanel').classList.remove('hidden');
        document.getElementById('headerRight').innerHTML = `<div class="teacher-badge">üéì Teacher <span class="logout-x" onclick="logout()">‚úï</span></div>`;
        if (!silent) showToast('‚úÖ Logged in!', 'ok');
      } else {
        if (!silent) document.getElementById('loginError').style.display = 'block';
      }
    } catch(e) { if (!silent) showToast('Connection error', 'err'); }
  }

  function logout() {
    savedUser = ''; savedPass = '';
    localStorage.removeItem('eq_tu'); localStorage.removeItem('eq_tp');
    document.getElementById('loginWall').classList.remove('hidden');
    document.getElementById('mainPanel').classList.add('hidden');
    document.getElementById('headerRight').innerHTML = '';
  }

  // ‚îÄ‚îÄ LOAD CLASS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadClass() {
    currentClass = document.getElementById('classSelect').value;
    if (!currentClass) { document.getElementById('studentsList').innerHTML = ''; document.getElementById('classInfo').textContent = ''; return; }
    document.getElementById('studentsList').innerHTML = '<div class="loading"><div class="spinner"></div><br/>Loading students...</div>';
    document.getElementById('classInfo').textContent = '';
    try {
      const data = await apiGet({ action: 'getAllActiveness', className: currentClass });
      if (data.error) { showToast(data.error, 'err'); document.getElementById('studentsList').innerHTML = ''; return; }
      studentsData = data.students;
      document.getElementById('classInfo').textContent = studentsData.length + ' students';
      renderStudents();
    } catch(e) { showToast('Failed to load class', 'err'); document.getElementById('studentsList').innerHTML = ''; }
  }

  // ‚îÄ‚îÄ RENDER STUDENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderStudents() {
    const grid = document.createElement('div');
    grid.className = 'students-grid';

    studentsData.forEach(s => {
      const total = (s.VocabularyBox || 0) + (s.Answering || 0) + (s.Presenting || 0) + (s.DoingTaskOnTime || 0) + (s.HelpingHand || 0);
      const totalClass = total >= 30 ? 'high' : total >= 10 ? 'mid' : 'low';
      const indClass   = s.Indicator.includes('Plus Ultra') ? 'ind-ultra' :
        s.Indicator.includes('Hyperactive') ? 'ind-hyper' :
        s.Indicator.includes('Super') ? 'ind-super' :
        s.Indicator.includes('Active') && !s.Indicator.includes('Not') ? 'ind-active' :
        s.Indicator.includes('Okay') ? 'ind-okay' : 'ind-not';

      const vals = {
        'Vocabulary Box':     s.VocabularyBox    || 0,
        'Answering':          s.Answering        || 0,
        'Presenting':         s.Presenting       || 0,
        'Doing Task On Time': s.DoingTaskOnTime  || 0,
        'Helping Hand':       s.HelpingHand      || 0,
      };

      const actRows = ACTS.map(a => `
        <div class="act-row">
          <span class="act-label" style="color:${a.col}">${a.short}</span>
          <div class="act-controls">
            <button class="act-btn minus" onclick="changeVal(${s.no},'${a.key}',-1,this)" ${vals[a.key] <= 0 ? 'disabled' : ''}>‚àí</button>
            <span class="act-val" id="val-${s.no}-${a.key.replace(/\s/g,'_')}">${vals[a.key]}</span>
            <button class="act-btn plus" onclick="changeVal(${s.no},'${a.key}',1,this)">+</button>
          </div>
        </div>`).join('');

      const card = document.createElement('div');
      card.className = 'student-card';
      card.id = 'card-' + s.no;
      card.innerHTML = `
        <div class="card-top">
          <span class="card-no">${s.no}</span>
          <span class="card-name">${s.nickname || s.name}</span>
          <span class="card-total ${totalClass}" id="total-${s.no}">${total}</span>
        </div>
        <div class="card-activities">${actRows}</div>
        <div class="card-indicator ${indClass}" id="ind-${s.no}">${s.Indicator || '‚Äî'}</div>`;

      grid.appendChild(card);
    });

    document.getElementById('studentsList').innerHTML = '';
    document.getElementById('studentsList').appendChild(grid);
  }

  // ‚îÄ‚îÄ CHANGE VALUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function changeVal(studentNo, column, delta, btn) {
    const valKey  = 'val-' + studentNo + '-' + column.replace(/\s/g, '_');
    const valEl   = document.getElementById(valKey);
    const totalEl = document.getElementById('total-' + studentNo);
    if (!valEl) return;

    const current  = parseInt(valEl.textContent) || 0;
    const newValue = Math.max(0, current + delta);
    if (newValue === current) return;

    // Optimistic update
    valEl.textContent = newValue;
    valEl.classList.add('changed');
    setTimeout(() => valEl.classList.remove('changed'), 600);

    // Update total display
    recalcTotal(studentNo);

    // Disable buttons briefly
    const card = document.getElementById('card-' + studentNo);
    card.querySelectorAll('.act-btn').forEach(b => b.disabled = true);

    try {
      const res = await apiGet({ action: 'incrementActiveness', username: savedUser, password: savedPass, className: currentClass, studentNo: String(studentNo), column, delta: String(delta) });
      if (res.success) {
        showToast(`+1 ${column.split(' ')[0]} ‚Üí ${res.newValue}`, 'ok');
        // Update minus btn state
        const minusBtn = valEl.previousElementSibling;
        if (minusBtn) minusBtn.disabled = res.newValue <= 0;
      } else {
        // Revert
        valEl.textContent = current;
        recalcTotal(studentNo);
        showToast('Error: ' + res.error, 'err');
      }
    } catch(e) {
      valEl.textContent = current;
      recalcTotal(studentNo);
      showToast('Failed to save', 'err');
    }

    card.querySelectorAll('.act-btn').forEach(b => b.disabled = false);
    // Re-check minus buttons
    card.querySelectorAll('.act-val').forEach(v => {
      v.previousElementSibling.disabled = parseInt(v.textContent) <= 0;
    });
  }

  function recalcTotal(studentNo) {
    const totalEl = document.getElementById('total-' + studentNo);
    if (!totalEl) return;
    let sum = 0;
    ACTS.forEach(a => {
      const el = document.getElementById('val-' + studentNo + '-' + a.key.replace(/\s/g, '_'));
      if (el) sum += parseInt(el.textContent) || 0;
    });
    totalEl.textContent = sum;
    totalEl.className = 'card-total ' + (sum >= 30 ? 'high' : sum >= 10 ? 'mid' : 'low');
  }

  // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.className = 'toast ' + (type || '');
    setTimeout(() => t.classList.add('show'), 10);
    setTimeout(() => t.classList.remove('show'), 2500);
  }

</script>
</body>
</html>
